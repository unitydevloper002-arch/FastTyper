<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>{{{ PRODUCT_NAME }}}</title>
	<style>
		html,
        body {
           background: {{{ BACKGROUND || '#000' }}};
           width: 100%;
           height: 100%;
           overflow: visible;
           padding: 0;
           margin: 0;
        }
 
        div#gameContainer {
           background: transparent !important;
           position: absolute;
        }
 
        div#gameContainer canvas {
           position: absolute;
        }
 
        div#gameContainer canvas[data-pixel-art="true"] {
           position: absolute;
           image-rendering: optimizeSpeed;
           image-rendering: -webkit-crisp-edges;
           image-rendering: -moz-crisp-edges;
           image-rendering: -o-crisp-edges;
           image-rendering: crisp-edges;
           image-rendering: -webkit-optimize-contrast;
           image-rendering: optimize-contrast;
           image-rendering: pixelated;
           -ms-interpolation-mode: nearest-neighbor;
        }
 
        /* Loading screen styles */
        #loadingScreen {
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           background: {{{ BACKGROUND || '#000' }}};
           display: flex;
           flex-direction: column;
           justify-content: center;
           align-items: center;
           z-index: 1000;
        }
 
        #loadingLogo {
           width: 120px;
           height: 120px;
           margin-bottom: 30px;
           object-fit: contain;
        }
 
        #loadingText {
           color: white;
           font-family: Arial, sans-serif;
           font-size: 14px;
           margin-top: 15px;
           opacity: 0.8;
        }
 
        .hidden {
           display: none !important;
        }
	</style>
</head>

<body>
<!-- Loading Screen -->
<div id="loadingScreen">
	<div id="loadingText">Loading FastTyper... 0%</div>
</div>

<div id="gameContainer">
	<canvas id="unity-canvas" width="{{{ WIDTH }}}" height="{{{ HEIGHT }}}" data-pixel-art="{{{ OPTIMIZE_FOR_PIXEL_ART }}}"></canvas>
	<script src="Build/{{{ LOADER_FILENAME }}}"></script>
	<script>
		var canvas = document.querySelector("#unity-canvas");
        var loadingScreen = document.querySelector("#loadingScreen");
        var loadingText = document.querySelector("#loadingText");
        
        var config = {
           dataUrl: "Build/{{{ DATA_FILENAME }}}",
           frameworkUrl: "Build/{{{ FRAMEWORK_FILENAME }}}",
           codeUrl: "Build/{{{ CODE_FILENAME }}}",
#if MEMORY_FILENAME
           memoryUrl: "Build/{{{ MEMORY_FILENAME }}}",
#endif
#if SYMBOLS_FILENAME
           symbolsUrl: "Build/{{{ SYMBOLS_FILENAME }}}",
#endif
           streamingAssetsUrl: "StreamingAssets",
           companyName: "{{{ COMPANY_NAME }}}",
           productName: "{{{ PRODUCT_NAME }}}",
           productVersion: "{{{ PRODUCT_VERSION }}}",
        };
        
        var scaleToFit;
        try {
           scaleToFit = !!JSON.parse("{{{ SCALE_TO_FIT }}}");
        } catch (e) {
           scaleToFit = true;
        }
        
        function progressHandler(progress) {
           var percent = Math.round(progress * 100);
           loadingText.textContent = 'Loading FastTyper... ' + percent + '%';
           
           // Hide loading screen when complete
           if (progress >= 1) {
              setTimeout(function() {
                 loadingScreen.classList.add('hidden');
              }, 500);
           }
        }
        
        function onResize() {
           var container = canvas.parentElement;
           var w;
           var h;

           if (scaleToFit) {
              w = window.innerWidth;
              h = window.innerHeight;

              var r = {{{ HEIGHT }}} / {{{ WIDTH }}};

              if (w * r > window.innerHeight) {
                 w = Math.min(w, Math.ceil(h / r));
              }
              h = Math.floor(w * r);
           } else {
              w = {{{ WIDTH }}};
              h = {{{ HEIGHT }}};
           }
           w = window.innerWidth;
           h = window.innerHeight;

           container.style.width = canvas.style.width = w + "px";
           container.style.height = canvas.style.height = h + "px";
           container.style.top = Math.floor((window.innerHeight - h) / 2) + "px";
           container.style.left = Math.floor((window.innerWidth - w) / 2) + "px";
        }
        
        createUnityInstance(canvas, config, progressHandler).then(function (instance) {
           canvas = instance.Module.canvas;
           onResize();

            const urlParams = new URLSearchParams(window.location.search);
            const matchId = urlParams.get("matchId");
            const playerId = urlParams.get("playerId");
            const opponentId = urlParams.get("opponentId");
            const replayMode = urlParams.get("replay");
            const testMode = urlParams.get("testMode"); // New test parameter

            // Store globally for .jslib use if needed
            window.matchId = matchId;
            window.playerId = playerId;
            window.opponentId = opponentId;
            window.replayMode = replayMode;
            window.testMode = testMode;

            console.log("[WebGL] URL Parameters:", { matchId, playerId, opponentId, replayMode, testMode });

            // Handle test mode
            if (testMode) {
                console.log("[WebGL] Test mode detected:", testMode);
                
                let testParams = {};
                switch (testMode) {
                    case "ai":
                        testParams = {
                            matchId: matchId || "test_ai",
                            playerId: playerId || "human_player",
                            opponentId: opponentId || "b912345678"
                        };
                        break;
                    case "multiplayer":
                        testParams = {
                            matchId: matchId || "test_multiplayer",
                            playerId: playerId || "human_player_1",
                            opponentId: opponentId || "human_player_2"
                        };
                        break;
                    default:
                        testParams = {
                            matchId: matchId || "test_default",
                            playerId: playerId || "human_player",
                            opponentId: opponentId || "b912345678"
                        };
                }
                
                // Send test parameters to Unity
                setTimeout(() => {
                    if (instance && instance.SendMessage) {
                        const jsonParams = JSON.stringify(testParams);
                        console.log("[WebGL] Sending test parameters to Unity:", jsonParams);
                        instance.SendMessage('IFrameBridge', 'InitParamsFromJS', jsonParams);
                    }
                }, 1000);
            } else {
                // Normal URL parameter handling
                if (matchId && playerId && opponentId) {
                    console.log("[WebGL] Normal mode - sending parameters to Unity");
                    setTimeout(() => {
                        if (instance && instance.SendMessage) {
                            const jsonParams = JSON.stringify({ matchId, playerId, opponentId });
                            instance.SendMessage('IFrameBridge', 'InitParamsFromJS', jsonParams);
                        }
                    }, 1000);
                } else {
                    console.log("[WebGL] No valid parameters found, using default test mode");
                    // Fallback to test mode
                    setTimeout(() => {
                        if (instance && instance.SendMessage) {
                            const testParams = JSON.stringify({
                                matchId: "test_default",
                                playerId: "human_player",
                                opponentId: "b912345678"
                            });
                            instance.SendMessage('IFrameBridge', 'InitParamsFromJS', testParams);
                        }
                    }, 1000);
                }
            }
        });
        
        window.addEventListener('resize', onResize);
        onResize();

        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
           // Mobile device style: fill the whole browser client area with the game canvas:
           const meta = document.createElement('meta');
           meta.name = 'viewport';
           meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
           document.getElementsByTagName('head')[0].appendChild(meta);
        }
	</script>
</div>
</body>

</html>
